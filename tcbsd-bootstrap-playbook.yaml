---
- hosts: "{{ target }}"
  gather_facts: False

  tasks:
    - name: Configure psproxy if needed
      ansible.builtin.raw: |
        if ! grep ANSIBLE /usr/local/etc/pkg.conf; then
          echo "
        # BEGIN ANSIBLE MANAGED BLOCK
        PKG_ENV {
            http_proxy: "http://psproxy:3128",
            https_proxy: "http://psproxy:3128",
        }
        # END ANSIBLE MANAGED BLOCK
        " >> /usr/local/etc/pkg.conf
        fi

    - name: Configure ntp if needed
      ansible.builtin.raw: |
        if ! grep ANSIBLE /etc/ntp.conf; then
          echo "
        # BEGIN ANSIBLE MANAGED BLOCK
        disable monitor

        # Permit time synchronization with our time source, but do not
        # permit the source to query or modify the service on this system.
        restrict default kod nomodify notrap nopeer noquery
        restrict 127.0.0.1

        server psntp1.pcdsn iburst
        server psntp2.pcdsn iburst
        server psntp3.pcdsn iburst
        # END ANSIBLE MANAGED BLOCK
        " >> /etc/ntp.conf

          # Stop ntp service, force a sync, start it again
          service ntpd stop
          ntpd -g -q
          service ntpd start
        fi

    - name: Install Python3 if needed
      ansible.builtin.raw: test -e /usr/local/bin/python3 || pkg install -y python3
